import { v4 } from 'uuid';
import Oe from 'stripe';
import $e from 'crypto';
import qe from 'https';
import Ne from 'buffer-crc32';

var c={MERCADO_PAGO:{name:"mercadopago",base_url:{production:"https://api.mercadopago.com",sandbox:"https://api.mercadopago.com"}},STRIPE:{name:"stripe",base_url:{production:"https://www.stripe.com",sandbox:"https://sandbox.stripe.com"}},PAYPAL:{name:"paypal",base_url:{production:"https://api-m.paypal.com",sandbox:"https://api-m.sandbox.paypal.com"}},TALO:{name:"talo",base_url:{production:"https://api.talo.com.ar",sandbox:"https://sandbox-api.talo.com.ar"}},SQUARE:{name:"square",base_url:{production:"https://connect.squareup.com",sandbox:"https://connect.squareupsandbox.com"}}};var Ae=async(t,e)=>{var r,o,a,n;try{let i=(r=t.platforms)==null?void 0:r.mercadopago;if(!i)throw new Error("MercadoPago credentials not found");let s=i.access_token;if(!s)throw new Error("MercadoPago access token not found");let p=e.items.map(g=>({...g,id:g.id||v4()})),d=v4(),m={items:p,binary_mode:!0,metadata:{identifier:d},external_reference:d,back_urls:{success:((o=e.options)==null?void 0:o.successRedirect)||"http://localhost:3000",pending:((a=e.options)==null?void 0:a.pendingRedirect)||"http://localhost:3000",failure:((n=e.options)==null?void 0:n.failureRedirect)||"http://localhost:3000"}},f=c.MERCADO_PAGO.base_url.production,u=await(await fetch(`${f}/checkout/preferences`,{method:"POST",body:JSON.stringify(m),headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`}})).json();return {message:"Mercadopago checkout created",payment_url:u.init_point,raw:u,identifier:d}}catch(i){throw console.error("Error creating MercadoPago checkout",i),i}},$=Ae;var Ie=async(t,e)=>{var o,a,n;let r=v4();try{let i=(o=t.platforms)==null?void 0:o.stripe;if(!i)throw new Error("Stripe credentials not found");let s=i.secret_key;if(!s)throw new Error("Stripe secret key not found");let p=new Oe(s),d=e.items.map(l=>{var u;return {price_data:{currency:((u=e.options)==null?void 0:u.currency)||"usd",product_data:{name:l.title},unit_amount:Math.round(l.unit_price*100)},quantity:l.quantity}}),m={payment_method_types:["card"],line_items:d,mode:"payment",metadata:{identifier:r},payment_intent_data:{metadata:{identifier:r}},success_url:((a=e.options)==null?void 0:a.successRedirect)||"http://localhost:3000/success",cancel_url:((n=e.options)==null?void 0:n.failureRedirect)||"http://localhost:3000/failure"},f=await p.checkout.sessions.create(m);return {message:"Payment checkout created",payment_url:f.url,raw:{...f},identifier:r}}catch(i){throw console.error("Error creating Stripe checkout",i),i}},L=Ie;var C=async(t,e,r)=>{try{let o=Buffer.from(`${t}:${e}`).toString("base64");return (await(await fetch(`${r}/v1/oauth2/token`,{method:"POST",body:"grant_type=client_credentials",headers:{Authorization:`Basic ${o}`}})).json()).access_token}catch(o){throw console.error("Failed to generate Access Token:",o),o}};var ve=async(t,e)=>{var r,o,a,n,i;try{let s=(r=t.platforms)==null?void 0:r.paypal;if(!s)throw new Error("Paypal credentials not found");let p=s.secret_key;if(!p)throw new Error("Paypal secret key not found");let d=s.client_id;if(!d)throw new Error("Paypal client id not found");let f=(s==null?void 0:s.sandbox)===!0?c.PAYPAL.base_url.sandbox:c.PAYPAL.base_url.production,l=await C(d,p,f),u=`${f}/v2/checkout/orders`,g=e.items.map(P=>{var b;return {name:P.title,unit_amount:{currency_code:((b=e.options)==null?void 0:b.currency)||"USD",value:P.unit_price.toFixed(2)},quantity:P.quantity.toString(),description:P.description||`${P.title} - ${P.quantity} unit(s)`}}),w=g.reduce((P,b)=>P+parseFloat(b.unit_amount.value)*parseInt(b.quantity),0),S={intent:"CAPTURE",purchase_units:[{amount:{currency_code:((o=e.options)==null?void 0:o.currency)||"USD",value:w.toFixed(2),breakdown:{item_total:{currency_code:((a=e.options)==null?void 0:a.currency)||"USD",value:w.toFixed(2)}}},items:g}],application_context:{return_url:((n=e.options)==null?void 0:n.successRedirect)||"http://localhost:3000",cancel_url:((i=e.options)==null?void 0:i.failureRedirect)||"http://localhost:3000"}},h=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify(S)}),y=await h.json();return h.ok?{message:"Paypal checkout created successfully",payment_url:y.links.find(b=>b.rel==="approve").href,raw:y,identifier:y.id}:(console.error("PayPal API Error:",{status:h.status,statusText:h.statusText,body:y,requestPayload:S}),{payment_url:"",message:y.message||"Failed to create PayPal order. Make sure that you are using the correct credentials for the environment. If your project is sandbox, make sure that you are using sandbox credentials. The identifier in this error is the paypal-debug-id",raw:y.details||[],identifier:h.headers.get("paypal-debug-id")})}catch(s){throw console.error("Error creating Paypal checkout",s),s}},D=ve;var v=async({user_id:t,client_id:e,client_secret:r,url:o})=>await fetch(`${o}/users/${t}/tokens`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:e,client_secret:r})}).then(n=>n.json());var Be=async(t,e)=>{var r,o,a,n,i;try{let s=(r=t.platforms)==null?void 0:r.talo;if(!s)throw new Error("MercadoPago credentials not found");let p=s.user_id,d=s.client_id,m=s.client_secret;if(!p||!d||!m)throw new Error("Talo credentials not found");let f=(s==null?void 0:s.sandbox)===!0,l=f?"sandbox":"production",u=f?c.TALO.base_url.sandbox:c.TALO.base_url.production,g=await v({user_id:p,client_id:d,client_secret:m,url:u});if(!((o=g.data)!=null&&o.token))return {raw:"talo_token_error",message:"Error getting Talo token.",payment_url:"null",identifier:"null"};let w=g.data.token,S=e.items.map(R=>({...R,id:R.id||v4()})),h=v4(),y=S.reduce((R,A)=>R+A.unit_price*A.quantity,0),P=S.map(R=>`${R.title} x${R.quantity}`).join(", "),b={price:{currency:((a=e.options)==null?void 0:a.currency)||"ARS",amount:Number(y)},user_id:p,redirect_url:((n=e.options)==null?void 0:n.successRedirect)||"http://localhost:3000/success",motive:P,external_id:h||v4(),webhook_url:"",payment_options:((i=e.options)==null?void 0:i.paymentMethods)||["crypto"]};s.webhooks_url&&(b.webhook_url=`${s.webhooks_url}?source_news=webhooks&mode=${l}&vexorPlatform=talo`);let k=await fetch(`${u}/payments/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${w}`},body:JSON.stringify(b)}).then(R=>R.json());return k.code!==200?{message:"talo_payment_error",raw:k,payment_url:"null",identifier:"null"}:{message:"Talo checkout created",payment_url:k.data.payment_url,raw:k,identifier:h}}catch(s){throw console.error("Error creating Talo checkout",s),s}},W=Be;var B=()=>" xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=Math.random()*16|0,r=t==="x"?e:e&3|8;return r.toString(16)});var X=async({url:t,accessToken:e})=>{try{let r=await fetch(`${t}/v2/locations`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}});if(!(r!=null&&r.ok))throw new Error(`HTTP error! status: ${r.status} 
Make sure the request is made from the server not from the client side`);return await r.json()}catch(r){throw console.error("Error fetching Square location:",r),r}};var Ue=async(t,e)=>{var r,o,a;try{let n=(r=t.platforms)==null?void 0:r.square;if(!n)throw new Error("Square credentials not found");let i=n.access_token;if(!i)throw new Error("Square access token not found");let s=(n==null?void 0:n.sandbox)===!0,p=s?c.SQUARE.base_url.sandbox:c.SQUARE.base_url.production,d=s?"sandbox":"production",m=await X({url:p,accessToken:i});if(!((o=m.locations)!=null&&o.length))return {raw:m,identifier:"Square_token_error",message:"Error getting Square token.",payment_url:""};let f=m.locations[0].id,l=e.items.map(y=>({...y,id:y.id||v4()})),u=l.reduce((y,P)=>y+P.unit_price*P.quantity,0),g=l.map(y=>`${y.title} x${y.quantity}`).join(", "),w={idempotency_key:B(),quick_pay:{name:g,price_money:{amount:Number(u*100),currency:((a=e.options)==null?void 0:a.currency)||"USD"},location_id:f},webhook_url:""};n.webhooks_url&&(w.webhook_url=`${n.webhooks_url}?source_news=webhooks&mode=${d}&vexorPlatform=Square`);let S=await fetch(`${p}/v2/online-checkout/payment-links`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},mode:"no-cors",body:JSON.stringify(w)}).then(y=>y.json()),h=S.related_resources.orders[0].id;return {message:"Payment checkout created",payment_url:S.payment_link.url,raw:S,identifier:h}}catch(n){throw console.error("Error creating Square checkout",n),n}},N=Ue;var Me=t=>Object.keys(t.platforms||{}).length>0,I={isOpenSource:Me};var Q=t=>Object.assign(e=>t.createCheckout(e.platform,e),{mercadopago:e=>t.createCheckout("mercadopago",e),stripe:e=>t.createCheckout("stripe",e),paypal:e=>t.createCheckout("paypal",e),talo:e=>t.createCheckout("talo",e),square:e=>t.createCheckout("square",e)});async function Z(t,e,r){if(I.isOpenSource(t)){let a;switch(e){case c.MERCADO_PAGO.name:a=await $(t,r);break;case c.STRIPE.name:a=await L(t,r);break;case c.PAYPAL.name:a=await D(t,r);break;case c.TALO.name:a=await W(t,r);break;case c.SQUARE.name:a=await N(t,r);break;default:throw new Error(`Unsupported platform: ${e}`)}return a}else {let a=await fetch(`${t.apiUrl}/payments`,{method:"POST",headers:{"Content-Type":"application/json","x-vexor-key":t.publishableKey,"x-vexor-platform":e,"x-vexor-project-id":t.projectId},body:JSON.stringify(r)}),n=await a.json();if(!a.ok){let i=n.message||"An unknown error occurred";throw new Error(`Payment request failed: ${i}`)}return n}}var ee=({x_signature:t,mercadopagoWebhookSecret:e,data_id:r,x_request_id:o})=>{var d,m,f,l,u,g;let a=(f=(m=(d=t==null?void 0:t.split(","))==null?void 0:d[0])==null?void 0:m.split("="))==null?void 0:f[1],n=(g=(u=(l=t==null?void 0:t.split(","))==null?void 0:l[1])==null?void 0:u.split("="))==null?void 0:g[1],i=`id:${r};request-id:${o};ts:${a};`,s=!1;return $e.createHmac("sha256",e).update(i).digest("hex")===n&&(s=!0),s};var K=async(t,e)=>{var p,d,m,f,l,u,g,w,S,h;let r=new URL(e.url),a=new URLSearchParams(r.searchParams).get("data.id"),n=e.headers.get("x-signature"),i=e.headers.get("x-request-id"),s=await e.json();try{let y=(p=t.platforms)==null?void 0:p.mercadopago;if(!y)throw new Error("MercadoPago credentials not found");let P=y.access_token,b=y.webhook_secret;if(!P)throw new Error("MercadoPago access token not found");if(!b)throw new Error("MercadoPago webhook secret not found");let k=(y==null?void 0:y.sandbox)===!0,R=k?c.MERCADO_PAGO.base_url.sandbox:c.MERCADO_PAGO.base_url.production;if(!k&&(!n||!i||!a))return console.log("Invalid request. The request does not contain the required headers."),{message:"Invalid request. The request does not contain the required headers.",status:"error",transmissionId:i||"",identifier:"",timeStamp:new Date().toISOString(),orderId:"",eventType:"",platform:c.MERCADO_PAGO.name,resource:null};if((s.live_mode||!k)&&!ee({x_signature:n,mercadopagoWebhookSecret:b,data_id:a,x_request_id:i}))throw new Error("Invalid signature");let A;switch(s.entity){case"preapproval_plan":A=`https://api.mercadopago.com/preapproval_plan/${s.data.id}`;break;case"preapproval":A=`https://api.mercadopago.com/preapproval/${s.data.id}`;break;default:A=`https://api.mercadopago.com/v1/payments/${s.data.id}`;break}let x=await(await fetch(A,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${P}`}})).json(),T="",V="Event processed",E="pending";switch(console.log("PAYMENT DATA",x),s.action){case"payment.created":if(V="Payment created with mercadopago transaction id: "+s.data.id,T=((d=x.metadata)==null?void 0:d.identifier)||x.external_reference||"",x.status==="approved"&&(E="paid"),((m=x.point_of_interaction)==null?void 0:m.type)==="SUBSCRIPTIONS"){let _=await(await fetch(`https://api.mercadopago.com/v1/payments/${s.data.id}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${P}`}})).json(),J=await(await fetch(`https://api.mercadopago.com/preapproval/${_.metadata.preapproval_id}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${P}`}})).json();V="Subscription created with mercadopago transaction id: "+s.data.id,T=((f=J.metadata)==null?void 0:f.identifier)||J.external_reference||"";}break;case"payment.updated":V="Payment updated with mercadopago transaction id: "+s.data.id,x.status&&(E=x.status),T=((l=x.metadata)==null?void 0:l.identifier)||x.external_reference||"";break;case"created":if(V="Subscription preapproval created with mercadopago transaction id: "+s.data.id,T=((u=x.metadata)==null?void 0:u.identifier)||x.external_reference||"",x.status&&(E=x.status),s.entity!=="preapproval_plan"&&s.entity!=="preapproval")if(s.entity==="authorized_payment"){let _=await(await fetch(`https://api.mercadopago.com/authorized_payments/${s.data.id}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${P}`}})).json();V=`Subscription payment authorization created with ID: ${s.data.id}. 
Debit date: ${new Date(_.debit_date).toLocaleDateString()}`,T=((g=_.metadata)==null?void 0:g.identifier)||_.external_reference||"",x=_,E=_.status;}else {let _=await(await fetch(`https://api.mercadopago.com/v1/payments/${s.data.id}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${P}`}})).json();_.status===404&&(E="pending",V="Subscription preapproval created with mercadopago transaction id: "+s.data.id+" but the subscription was not found in Mercadopago. This may occur if the user has not paid yet, even though, mercadopago emits an update. \u26A0\uFE0F THIS RESPONSE WILL NOT CONTAIN ANY IDENTIFIER."),console.log("PREAPPROVAL DATA",_),T=((w=_.metadata)==null?void 0:w.identifier)||_.external_reference||"",x=_;}break;case"updated":V="Subscription updated with mercadopago transaction id: "+s.data.id,x.status&&(E=x.status),T=((S=x.metadata)==null?void 0:S.identifier)||x.external_reference||"",x.status===404&&(E="pending",V="Subscription update received with mercadopago transaction id: "+s.data.id+" but the subscription was not found in Mercadopago. This may occur if the user has not paid yet, even though, mercadopago emits an update. \u26A0\uFE0F THIS RESPONSE WILL NOT CONTAIN ANY IDENTIFIER."),x.status==="authorized"&&x.next_payment_date>new Date&&(E=x.status),T=((h=x.metadata)==null?void 0:h.identifier)||x.external_reference||"";break;default:console.error("Unhandled event type:",s.action),V="Mercadopago events supported: payment.created, created, updated, payment.updated";}return {message:V,status:E,transmissionId:i||"",identifier:T,timeStamp:new Date().toISOString(),orderId:s.data.id,eventType:s.action,platform:c.MERCADO_PAGO.name,resource:x}}catch(y){return console.error(y),{message:"Error processing MercadoPago webhook",status:"error",transmissionId:i||"",identifier:"",timeStamp:new Date().toISOString(),orderId:"",eventType:"",platform:c.MERCADO_PAGO.name,resource:null}}};async function De(t,e,r=10){var o;for(let a=0;a<r;a++){let n=await t.subscriptions.retrieve(e);if((o=n.metadata)!=null&&o.identifier)return n;await new Promise(i=>setTimeout(i,1e3*(a+1)));}throw new Error("Subscription metadata not available after retries")}var G=async(t,e)=>{var n;let r=await e.text(),o=JSON.parse(r),a=e.headers.get("Stripe-Signature");if(!a)return {message:"Missing signature",status:"error",transmissionId:"",identifier:"",timeStamp:new Date().toISOString(),orderId:"",eventType:"",platform:c.STRIPE.name,resource:null};try{let i=(n=t.platforms)==null?void 0:n.stripe,s=i==null?void 0:i.public_key,p=i==null?void 0:i.secret_key,d=i==null?void 0:i.webhook_secrets;if(!s)throw new Error("Stripe public key not found");if(!p)throw new Error("Stripe secret key not found");if(!(d!=null&&d.length))throw new Error("Stripe webhook secrets not found");let f=(i==null?void 0:i.sandbox)===!0?c.STRIPE.base_url.sandbox:c.STRIPE.base_url.production,l=null,u=new Oe(p,{typescript:!0});for(let y of d)try{l=u.webhooks.constructEvent(r,a,y);break}catch{console.log("Webhook signature verification failed with a secret, trying next one if available");continue}if(!l)return console.error("Webhook signature verification failed with all secrets"),{message:"Webhook signature verification failed",status:"error",transmissionId:"",identifier:"",timeStamp:new Date().toISOString(),orderId:"",eventType:"",platform:c.STRIPE.name,resource:null};let g=o.data.object.billing_reason==="subscription_create"||o.data.object.mode==="subscription",w="Event processed",S="pending",h="";switch(l.type){case"checkout.session.completed":if(console.log("Payment created with order id:",o.data.object.metadata.identifier),w="Payment created with order id: "+o.data.object.metadata.identifier,S=o.data.object.payment_status,h=o.data.object.metadata.identifier,g){let y=o.data.object.subscription,P=await u.subscriptions.update(y,{metadata:{identifier:o.data.object.metadata.identifier}});console.log("Updated subscription:",P),w="Subscription created and updated with identifier: "+o.data.object.metadata.identifier,h=o.data.object.metadata.identifier;}break;case"invoice.payment_succeeded":if(console.log("Payment succeeded with invoice id:",o.data.object.metadata.identifier),h=o.data.object.metadata.identifier,w="Payment succeeded with invoice id: "+o.data.object.metadata.identifier,S=o.data.object.payment_status,g){let y=o.data.object.subscription;try{let P=await De(u,y);console.log("Subscription:",P),w="Subscription payment succeeded and updated with id: "+P.metadata.identifier,o.data.object.metadata.identifier=P.metadata.identifier,h=P.metadata.identifier;}catch(P){console.error("Failed to get subscription metadata:",P),S="pending",w="Subscription payment processed, but metadata not yet available";}}break;case"account.updated":console.log("Account updated:",o.data.object),S="success",w="Account updated with id: "+o.data.object.metadata.identifier,h=o.data.object.metadata.identifier;break;default:return console.error("Unhandled event type:",l.type),{message:`Stripe events supported: checkout.session.completed, invoice.payment_succeeded. 
Using vexor.webhook() with unsupported events may result in unnecessary operations charges. Please ensure you only use supported events to optimize your usage.`,status:"error",transmissionId:"",identifier:"",timeStamp:new Date().toISOString(),orderId:"",eventType:"",platform:c.STRIPE.name,resource:null}}return {message:w,status:S,transmissionId:o.data.object.id,identifier:h,timeStamp:new Date().toISOString(),orderId:o.data.object.payment_intent,eventType:l.type,platform:c.STRIPE.name,resource:o.data.object}}catch(i){return console.error(i),{message:"Error processing Stripe webhook",status:"error",transmissionId:"",identifier:"",timeStamp:new Date().toISOString(),orderId:"",eventType:"",platform:c.STRIPE.name,resource:null}}};function te(t){switch(t.toUpperCase()){case"SHA256WITHRSA":return "RSA-SHA256";case"SHA1WITHRSA":return "RSA-SHA1";default:throw new Error(`Unsupported authentication algorithm: ${t}`)}}async function re(t){return new Promise((e,r)=>{qe.get(t,o=>{let a="";o.on("data",n=>{a+=n;}),o.on("end",()=>{e(a);});}).on("error",o=>{r(o);});})}async function oe(t,e,r,o){try{let a=await re(r),n=te(o),i=$e.createVerify(n);i.update(t);let s=Buffer.from(e,"base64");return i.verify(a,s)}catch(a){return console.error("Error verifying signature:",a),!1}}var ae=async(t,e)=>{var r,o,a,n,i,s;try{let p=(o=(r=t.platforms)==null?void 0:r.paypal)==null?void 0:o.secret_key;if(!p)throw new Error("Paypal secret key not found");let d=(n=(a=t.platforms)==null?void 0:a.paypal)==null?void 0:n.client_id;if(!d)throw new Error("Paypal client id not found");let f=((s=(i=t.platforms)==null?void 0:i.paypal)==null?void 0:s.sandbox)===!0?c.PAYPAL.base_url.sandbox:c.PAYPAL.base_url.production,l=await C(d,p,f);return await fetch(`${f}/v2/checkout/orders/${e}/capture`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`}})}catch(p){throw console.error("Error capturing paypal payment:",p),new Error("Error capturing paypal payment")}};var z=async(t,e)=>{var m,f,l;let r=await e.text(),o=e.headers,a=o.get("paypal-transmission-id"),n=o.get("paypal-transmission-time"),i=o.get("paypal-cert-url"),s=o.get("paypal-auth-algo"),p=o.get("paypal-transmission-sig"),d=parseInt("0x"+Ne(Buffer.from(r)).toString("hex"));try{let u=JSON.parse(r),g=(m=t.platforms)==null?void 0:m.paypal;if(!g)throw new Error("Paypal credentials not found");let w=g.secret_key,S=g.webhook_id;if(!w)throw new Error("Paypal secret key not found");if(!S)throw new Error("Paypal webhook id not found");let h;switch(u.event_type){case"CHECKOUT.ORDER.APPROVED":h=u.resource.id;break;case"PAYMENT.CAPTURE.COMPLETED":h=(l=(f=u.resource.supplementary_data)==null?void 0:f.related_ids)==null?void 0:l.order_id;break;case"BILLING.SUBSCRIPTION.ACTIVATED":h=u.resource.id;break;case"BILLING.SUBSCRIPTION.REACTIVATED":h=u.resource.id;break;case"PAYMENT.SALE.COMPLETED":h=u.resource.billing_agreement_id;break;default:return console.error("Unhandled event type:",u.event_type),{message:"Unhandled event type: "+u.event_type,status:"error",platform:c.PAYPAL.name,resource:null,eventType:u.event_type,transmissionId:a||"",identifier:"",timeStamp:new Date().toISOString(),orderId:""}}let y=`${a}|${n}|${S}|${d}`;if(!await oe(y,p,i,s))throw new Error("Invalid signature");let b="pending",k="Event processed";switch(u.event_type){case"CHECKOUT.ORDER.APPROVED":let U=await(await ae(t,u.resource.id)).json();U.error?k="Error capturing payment: "+U.error:k="Payment approved with order id: "+h;break;case"PAYMENT.CAPTURE.COMPLETED":k="Payment captured with order id: "+h,b="paid";break;case"BILLING.SUBSCRIPTION.ACTIVATED":k="Subscription activated with id: "+h,b="active";break;case"PAYMENT.SALE.COMPLETED":k="Subscription payment completed with id: "+h,b="paid";break;case"BILLING.SUBSCRIPTION.REACTIVATED":k="Subscription reactivated with id: "+h,b="active";break;case"PAYMENT.CAPTURE.REFUNDED":k="Payment captured refunded with id: "+h,b="refunded";break;default:k="Unhandled event type: "+u.event_type;}return {message:k,status:b,platform:c.PAYPAL.name,identifier:h,transmissionId:a,timeStamp:n,orderId:h,eventType:u.event_type,resource:u.resource}}catch(u){return console.error(u),{message:"Error processing Paypal webhook",status:"error",transmissionId:a||"",identifier:"",timeStamp:new Date().toISOString(),orderId:"",eventType:"",platform:c.PAYPAL.name,resource:"null"}}};var ne=async(t,e)=>{var d,m;let r=(d=t.platforms)==null?void 0:d.talo;if(!r)throw new Error("Talo credentials not found");let o=(r==null?void 0:r.sandbox)===!0,n=o?c.TALO.base_url.sandbox:c.TALO.base_url.production,i=await v({user_id:r.user_id,client_id:r.client_id,client_secret:r.client_secret,url:n});if(!((m=i.data)!=null&&m.token))throw new Error("Talo token not found");let s=i.data.token;return await fetch(`${n}/payments/${e}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`}}).then(f=>f.json())};var F=async(t,e)=>{var r,o;try{let a=await e.text(),n=JSON.parse(a),i=(r=t.platforms)==null?void 0:r.talo;if(!i)throw new Error("Talo credentials not found");let s=i.user_id,p=i.client_id,d=i.client_secret;if(!s||!p||!d)throw new Error("Talo credentials are incomplete");let m=await ne(t,((o=n.data)==null?void 0:o.id)||n.paymentId),f=m.data.status;return (f==="SUCCESS"||f==="OVERPAID")&&(f="paid"),{message:n.message,status:f,platform:c.TALO.name,identifier:m.data.external_id,transmissionId:n.paymentId,timeStamp:new Date().toISOString(),orderId:m.data.id,eventType:n.message,resource:m}}catch(a){throw console.log("Talo webhook error:",a),a}};var se=({request:t,webhooks_url:e,webhook_signature_key:r,signature:o})=>{try{let a=Buffer.from(e+t,"utf-8"),n=Buffer.from(r,"utf-8"),i=$e.createHmac("sha256",n);return i.update(a),i.digest("base64")===o}catch(a){return console.error("Error verifying Square signature:",a),!1}};var Y=async(t,e)=>{var a;let r=await e.text(),o=e.headers.get("x-square-hmacsha256-signature");try{let n=JSON.parse(r),i=(a=t.platforms)==null?void 0:a.square;if(!i)throw new Error("Paypal credentials not found");let s=i.access_token,p=i.application_id,d=i.webhooks_url,m=i.webhook_signature_key;if(!s)throw new Error("Square access token not found");if(!p)throw new Error("Square application id not found");if(!d)throw new Error("Square webhooks url not found");if(!m)throw new Error("Square webhook signature key not found");if(!se({request:r,signature:o,webhook_signature_key:m,webhooks_url:d}))throw new Error("Invalid signature");let l="",u="";switch(n.type){case"payment.updated":l=n.data.object.payment.order_id,u=n.data.object.payment.status;break;case"order.updated":l=n.data.object.order_updated.order_id,u=n.data.object.order_updated.state;break;default:return console.error("Unhandled event type:",n.type),{message:"Unhandled event type: "+n.type,status:"unhandled_event_type",platform:c.SQUARE.name,identifier:"",transmissionId:"",timeStamp:new Date().toISOString(),orderId:"",eventType:"",resource:"null"}}return {message:"Event processed",status:u,platform:c.SQUARE.name,identifier:l,transmissionId:n.data.id,timeStamp:new Date().toISOString(),orderId:l,eventType:n.type,resource:n.data}}catch(n){return console.error(n),{message:"Error processing Square webhook",status:"error",transmissionId:"",identifier:"",timeStamp:new Date().toISOString(),orderId:"",eventType:"",platform:c.SQUARE.name,resource:""}}};var ie=t=>Object.assign(e=>t.handleWebhook(e),{mercadopago:e=>t.handleWebhook(e),stripe:e=>t.handleWebhook(e),paypal:e=>t.handleWebhook(e),talo:e=>t.handleWebhook(e),square:e=>t.handleWebhook(e)});async function ce(t,e){var s;let r=e.headers,o=new URL(e.url),a=new URLSearchParams(o.searchParams),n;if(r.get("paypal-transmission-id")?n="paypal":r.get("stripe-signature")?n="stripe":(s=r.get("referer"))!=null&&s.includes("mercadopago")?n="mercadopago":a.get("vexorPlatform")==="talo"?n="talo":r.get("x-square-hmacsha256-signature")&&(n="square"),!n)throw new Error("Unsupported payment platform or missing signature header");if(I.isOpenSource(t)){let p;switch(n){case c.MERCADO_PAGO.name:p=await K(t,e);break;case c.STRIPE.name:p=await G(t,e);break;case c.PAYPAL.name:p=await z(t,e);break;case c.TALO.name:p=await F(t,e);break;case c.SQUARE.name:p=await Y(t,e);break;default:throw new Error(`Unsupported platform: ${n}`)}return p}else {let p=await e.text();if(!t.secretKey)throw new Error("Missing VEXOR_SECRET_KEY environment variable");let d=new Request(`${t.apiUrl}/webhooks/${n}?${a.toString()}`,{method:e.method,headers:new Headers(r),body:p});return d.headers.set("x-vexor-key",t.secretKey),d.headers.set("x-vexor-platform",n),d.headers.set("x-vexor-project-id",t.projectId),await(await fetch(d)).json()}}var pe=t=>Object.assign(e=>t.createSubscription(e.platform,e),{mercadopago:e=>t.createSubscription("mercadopago",e),stripe:e=>t.createSubscription("stripe",e),paypal:e=>t.createSubscription("paypal",e)});async function de(t,e,r){let o=await fetch(`${t.apiUrl}/subscriptions`,{method:"POST",headers:{"Content-Type":"application/json","x-vexor-key":t.publishableKey,"x-vexor-platform":e,"x-vexor-project-id":t.projectId},body:JSON.stringify(r)}),a=await o.json();if(!o.ok){let n=a.message||"An unknown error occurred";throw new Error(`Subscription request failed: ${n}`)}return a}var ue=t=>Object.assign(e=>t.createPortal(e.platform,e),{mercadopago:e=>t.createPortal("mercadopago",e),stripe:e=>t.createPortal("stripe",e),paypal:e=>t.createPortal("paypal",e)});async function me(t,e,r){let o=await fetch(`${t.apiUrl}/portals`,{method:"POST",headers:{"Content-Type":"application/json","x-vexor-key":t.publishableKey,"x-vexor-platform":e,"x-vexor-project-id":t.projectId},body:JSON.stringify(r)}),a=await o.json();if(!o.ok){let n=a.message||"An unknown error occurred";throw new Error(`Portal request failed: ${n}`)}return a}var le=t=>Object.assign(e=>t.createConnect(e.platform,e),{mercadopago:e=>t.createConnect("mercadopago",e),stripe:e=>t.createConnect("stripe",e),auth:Object.assign(e=>t.createConnectAuth(e),{refresh:e=>t.createConnectAuthRefresh(e)}),pay:Object.assign(e=>t.createConnectPay(e.platform,e),{mercadopago:e=>t.createConnectPay("mercadopago",e),stripe:e=>t.createConnectPay("stripe",e)}),dashboard:e=>t.createConnectDashboard(e),refund:Object.assign(e=>t.createConnectRefund(e.platform,e),{mercadopago:e=>t.createConnectRefund("mercadopago",e),stripe:e=>t.createConnectRefund("stripe",e)})});async function fe(t,e,r){let o=await fetch(`${t.apiUrl}/connect`,{method:"POST",headers:{"Content-Type":"application/json","x-vexor-key":t.secretKey,"x-vexor-platform":e,"x-vexor-project-id":t.projectId,"x-vexor-action":"connect"},body:JSON.stringify(r)}),a=await o.json();if(!o.ok){let n=a.message||"An unknown error occurred";throw new Error(`Connect request failed: ${n}`)}return a}async function ye(t,e){let r=await fetch(`${t.apiUrl}/connect`,{method:"POST",headers:{"Content-Type":"application/json","x-vexor-key":t.secretKey,"x-vexor-platform":"mercadopago","x-vexor-project-id":t.projectId,"x-vexor-action":"get_credentials"},body:JSON.stringify(e)}),o=await r.json();if(!r.ok){let a=o.message||"An unknown error occurred";throw new Error(`Connect auth request failed: ${a}`)}return o}async function he(t,e,r){let o=await fetch(`${t.apiUrl}/connect`,{method:"POST",headers:{"Content-Type":"application/json","x-vexor-key":t.secretKey,"x-vexor-platform":e,"x-vexor-project-id":t.projectId,"x-vexor-action":"create_payment"},body:JSON.stringify(r)}),a=await o.json();if(!o.ok){let n=a.message||"An unknown error occurred";throw new Error(`Connect pay request failed: ${n}`)}return a}async function Pe(t,e){let r=await fetch(`${t.apiUrl}/connect`,{method:"POST",headers:{"Content-Type":"application/json","x-vexor-key":t.secretKey,"x-vexor-platform":"stripe","x-vexor-project-id":t.projectId,"x-vexor-action":"get_dashboard_link"},body:JSON.stringify(e)}),o=await r.json();if(!r.ok){let a=o.message||"An unknown error occurred";throw new Error(`Connect dashboard request failed: ${a}`)}return o}async function xe(t,e,r){let o=await fetch(`${t.apiUrl}/connect`,{method:"POST",headers:{"Content-Type":"application/json","x-vexor-key":t.secretKey,"x-vexor-platform":e,"x-vexor-project-id":t.projectId,"x-vexor-action":"create_refund"},body:JSON.stringify(r)}),a=await o.json();if(!o.ok){let n=a.message||"An unknown error occurred";throw new Error(`Connect refund request failed: ${n}`)}return a}async function ge(t,e){let r=await fetch(`${t.apiUrl}/connect`,{method:"POST",headers:{"Content-Type":"application/json","x-vexor-key":t.secretKey,"x-vexor-platform":"mercadopago","x-vexor-project-id":t.projectId,"x-vexor-action":"refresh_credentials"},body:JSON.stringify(e)}),o=await r.json();if(!r.ok){let a=o.message||"An unknown error occurred";throw new Error(`Connect auth refresh request failed: ${a}`)}return o}var Ge=async(t,e)=>{var r;try{let o=(r=t.platforms)==null?void 0:r.mercadopago;if(!o)throw new Error("MercadoPago credentials not found");let a=o.access_token;if(!a)throw new Error("MercadoPago access token not found");let n=c.MERCADO_PAGO.base_url.production;return {message:"Mercadopago operation retrieved",raw:(await(await fetch(`${n}/v1/payments/search?sort=date_created&criteria=desc&external_reference=${e}&begin_date=NOW-364DAYS&end_date=NOW`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`}})).json()).results[0],identifier:e}}catch(o){throw console.error("Error retrieving MercadoPago operation",o),o}},we=Ge;var ze=async(t,e)=>{var r;try{let o=(r=t.platforms)==null?void 0:r.mercadopago;if(!o)throw new Error("MercadoPago credentials not found");let a=o.access_token;if(!a)throw new Error("MercadoPago access token not found");let n=B(),i=c.MERCADO_PAGO.base_url.production,s=await we(t,e.identifier);if(!s.raw)throw new Error("MercadoPago payment not found");let p=s.raw.id,d=await fetch(`${i}/v1/payments/${p}/refunds`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`,"X-Idempotency-Key":n}}).then(m=>m.json());if(d.error)throw new Error(d.error);return {message:"MercadoPago payment refunded",raw:d,identifier:e.identifier}}catch(o){return {message:"Error refunding MercadoPago payment",raw:o,identifier:e.identifier,error:o.message||"Unknown error"}}},Se=ze;var Ye=async(t,e)=>{var r;try{let o=(r=t.platforms)==null?void 0:r.stripe;if(!o)throw new Error("Stripe credentials not found");let a=o.secret_key;if(!a)throw new Error("Stripe secret key not found");return {message:"Stripe operation retrieved",raw:(await new Oe(a).paymentIntents.search({query:`metadata["identifier"]:"${e}"`})).data[0],identifier:e}}catch(o){throw console.error("Error retrieving Stripe operation",o),o}},be=Ye;var j=t=>JSON.parse(JSON.stringify(t,(e,r)=>typeof r=="bigint"?r.toString():r instanceof Date?r.toISOString():r));var He=async(t,e)=>{var r;try{let o=(r=t.platforms)==null?void 0:r.stripe;if(!o)throw new Error("Stripe credentials not found");let a=o.secret_key;if(!a)throw new Error("Stripe secret key not found");let n=new Oe(a),i=await be(t,e.identifier);if(!i.raw)throw new Error("Stripe payment not found");let s=i.raw.id,p=await n.refunds.create({payment_intent:s,metadata:{identifier:e.identifier}});return {message:"Stripe payment refunded",raw:j(p),identifier:e.identifier}}catch(o){return {message:"Error refunding Stripe payment",raw:o,identifier:e.identifier,error:o.message||"Unknown error"}}},ke=He;var Xe=async(t,e)=>{var r;try{let o=(r=t.platforms)==null?void 0:r.paypal;if(!o)throw new Error("Paypal credentials not found");let a=o.client_id;if(!a)throw new Error("Paypal client id not found");let n=o.secret_key;if(!n)throw new Error("Paypal secret key not found");let s=(o==null?void 0:o.sandbox)===!0?c.PAYPAL.base_url.sandbox:c.PAYPAL.base_url.production,p=await C(a,n,s),m=await(await fetch(`${s}/v2/checkout/orders/${e}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${p}`}})).json();if(m.status==="COMPLETED"){let f=m.purchase_units[0].payments.captures[0].id,u=await(await fetch(`${s}/v2/payments/captures/${f}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${p}`}})).json();return {message:"Paypal operation retrieved",raw:{order:m,capture:u},identifier:e}}return {message:"Paypal operation retrieved",raw:m,identifier:e}}catch(o){throw console.error("Error retrieving Paypal operation",o),o}},_e=Xe;var Qe=async(t,e)=>{var r,o;try{let a=(r=t.platforms)==null?void 0:r.paypal;if(!a)throw new Error("Paypal credentials not found");let n=a.client_id;if(!n)throw new Error("Paypal client id not found");let i=a.secret_key;if(!i)throw new Error("Paypal secret key not found");let p=(a==null?void 0:a.sandbox)===!0?c.PAYPAL.base_url.sandbox:c.PAYPAL.base_url.production,d=await C(n,i,p),m=await _e(t,e.identifier);if(!((o=m.raw)!=null&&o.capture))throw new Error("Paypal payment capture not found. Order is not completed yet or not found.");let f=m.raw.capture.id,l=await fetch(`${p}/v2/payments/captures/${f}/refund`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`,"PayPal-Request-Id":e.identifier}});if(!l.ok&&l.status!==200&&l.status!==201)throw new Error("Error refunding Paypal payment");return {message:"Paypal payment refunded",raw:j(await l.json()),identifier:e.identifier}}catch(a){return {message:"Error refunding Paypal payment",raw:a,identifier:e.identifier,error:a.message||"Unknown error"}}},Re=Qe;var Ve=t=>Object.assign(e=>t.createRefund(e.platform,e),{mercadopago:e=>t.createRefund("mercadopago",e),stripe:e=>t.createRefund("stripe",e),paypal:e=>t.createRefund("paypal",e)});async function Te(t,e,r){if(I.isOpenSource(t)){let a;switch(e){case c.MERCADO_PAGO.name:a=await Se(t,r);break;case c.STRIPE.name:a=await ke(t,r);break;case c.PAYPAL.name:a=await Re(t,r);break;default:throw new Error(`Unsupported platform: ${e}`)}return a}else {let a=await fetch(`${t.apiUrl}/refunds`,{method:"POST",headers:{"Content-Type":"application/json","x-vexor-key":t.secretKey,"x-vexor-platform":e,"x-vexor-project-id":t.projectId},body:JSON.stringify(r)}),n=await a.json();if(!a.ok){let i=n.message||"An unknown error occurred";throw new Error(`Refund request failed: ${i}`)}return n}}var O=class O{constructor(e){this.apiUrl="https://www.vexorpay.com/api";this.publishableKey=e.publishableKey,this.secretKey=e.secretKey,this.projectId=e.projectId,this.platforms=e.platforms||{},this.pay=Q(this),this.webhook=ie(this),this.subscribe=pe(this),this.portal=ue(this),this.connect=le(this),this.refund=Ve(this),this.custom=r=>this.setApiUrl(r);}static fromEnv(){if(!O.instance){let r=process.env.NEXT_PUBLIC_VEXOR_PUBLISHABLE_KEY||process.env.VEXOR_PUBLISHABLE_KEY,o=process.env.NEXT_PUBLIC_VEXOR_SECRET_KEY||process.env.VEXOR_SECRET_KEY,a=process.env.NEXT_PUBLIC_VEXOR_PROJECT||process.env.VEXOR_PROJECT;if(!r)throw new Error("Missing environment variable for publishable key");if(!a)throw new Error("Missing environment variable for project ID");O.instance=new O({publishableKey:r,projectId:a,secretKey:o});}let e=O.instance;return e.custom=function(r){return this.setApiUrl(r)},e}static init(e){if(e.platforms&&(e.publishableKey||e.secretKey||e.projectId))throw new Error("Vexor Cloud and Vexor OpenSource cannot be used together, please define only the platforms if you are using Vexor OpenSource or only the publishableKey, secretKey and projectId if you are using Vexor Cloud");let r=new O(e);return r.custom=function(o){return this.setApiUrl(o)},r}createCheckout(e,r){return Z(this,e,r)}handleWebhook(e){return ce(this,e)}createSubscription(e,r){return de(this,e,r)}createPortal(e,r){return me(this,e,r)}createConnect(e,r){return fe(this,e,r)}createConnectAuth(e){return ye(this,e)}createConnectPay(e,r){return he(this,e,r)}createConnectDashboard(e){return Pe(this,e)}createConnectAuthRefresh(e){return ge(this,e)}createConnectRefund(e,r){return xe(this,e,r)}createRefund(e,r){return Te(this,e,r)}setApiUrl(e){return this.apiUrl=e,this}};O.instance=null;var Ee=O;

export { Ee as Vexor };
//# sourceMappingURL=index.mjs.map
//# sourceMappingURL=index.mjs.map